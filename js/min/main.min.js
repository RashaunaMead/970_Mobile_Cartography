function initialize(){cacheloading(),loadmap(),$(document).foundation({orbit:{animation:"slide",navigation_arrows:!0,circular:!0,timer:!1,swipe:!1,next_class:"orbit-next",prev_class:"orbit-prev",timer_show_progress_bar:!1}}),/iPhone|iPad|iPod/i.test(navigator.userAgent)&&(iOS=!0,$(".has-dropdown a").css("background-color","#C41E3A"),$(".has-dropdown a").mouseenter(function(){$(this).css("background-color","#C41E3A")})),/iPhone|iPad|iPod|Android|BlackBerry/i.test(navigator.userAgent)&&(mobileOS=!0),queue().defer(d3.json,"data/routes.geojson").defer(d3.json,"data/PointsofInterest.geojson").defer(d3.json,"data/alerts.geojson").defer(d3.json,"data/help.json").await(callback)}function callback(e,t,o,i,a){function n(){Math.round($("#playBubble").offset().top)===Math.round(R[0]-90)&&($("#playBubble").fadeOut(),$("#iconClickBubble").fadeOut())}function r(){if($("#iconClickBubble span").html().length<1){$("#iconClickBubble span").html("When ready, click icon<br/>for site information"),$(".leaflet-marker-icon").each(function(){"images/labor40_red.png"==$(this).attr("src")&&(z=$(this))}),z||(z=$(".leaflet-marker-pane").find("img:last"));var e=z.offset(),t=$("#iconClickBubble").width(),o=$("#iconClickBubble").height(),i=e.top-o-32,a=e.left-t+28;$("#iconClickBubble").offset({top:10,left:10}),$("#iconClickBubble").animate({opacity:1,top:i,left:a},1e3),$(window).click(function(){Math.round($("#iconClickBubble").offset().top)===Math.round(i)&&$("#iconClickBubble").fadeOut()}),$(".leaflet-clickable").click(function(){$("#iconClickBubble").fadeOut()}),map.on("move",function(){s()})}}function s(){if($("#iconClickBubble span").html().length>1){var e=z.offset(),t=$("#iconClickBubble").width(),o=$("#iconClickBubble").height(),i=e.top-o-32,a=e.left-t+28;$("#iconClickBubble").offset({top:i,left:a}),0==Z&&$(window).click(function(){$("#iconClickBubble").fadeOut()}),Z=!0}}function l(e,t){$("audio").prop("autoplay",!0),$("audio").attr("src","data:audio/mp3;base64,"+e),t&&d(),$("audio").get(0).play()}function c(e,t){$.ajax(o.features[t].properties.audio,{dataType:"text",success:function(o){l(o,e,t)}})}function d(){$("audio").show(),iOS&&$("audio").css({width:"60px",height:"10px","margin-right":"20px","margin-top":"10px"})}function u(){$("audio").get(0).pause(),$("audio").prop("autoplay",!1),$("audio").hide(),iOS&&$("audio").css({width:0,height:0,"margin-right":0})}function p(){var e=!0;$("#readAloud span").html("&nbsp;&nbsp;Read Text Aloud"),$("#readAloud div").unbind("click"),$("#readAloud div").click(function(){if(e){var t=o.features[currentFeature].properties.Scripts;b("#textModal",0,t);var i=0;for(var a in timeouts)clearTimeout(timeouts[a]);for(var n=0;n<t.length-1;n++)i+=68.2*t[n].length,timeouts[n]=window.setTimeout(function(){g("#textModal",t)},i);c(!0,currentFeature)}m(e),e=!1})}function m(e){e||$("audio").get(0).paused?e||$("audio").get(0).play():($("audio").get(0).pause(),f())}function f(){for(var e in timeouts)window.clearTimeout(timeouts[e])}function h(e,t,o,i){U=0,$(e+" .script").before("<div class='redButtonContainer scriptButtonContainer'><div class='redButton scriptButtons' id='next'><a href='#'><div>next ></div></a></div><div class='redButton scriptButtons' id='previous'><a href='#'><div>< previous</div></a></div></div>"),$(e+" #next").click(function(){"#textModal"==e&&f(),g(e,t,o,i)}),$(e+" #previous").click(function(){U--,U=-1==U?t.length-1:U,b(e,U,t,o,i);for(var a in timeouts)window.clearTimeout(timeouts[a])})}function g(e,t,o,i){U++,U=U==t.length?0:U,b(e,U,t,o,i)}function b(e,t,o){$(e+" .script").html(o[t]),0===$(e+" #next").length&&h(e,o)}function v(){$("#textModal #next").remove(),$("#textModal #previous").remove(),$("#textModal .script").html(o.features[siteID].properties.Scripts[0])}function w(){if(5>siteID){{L.geoJson(t.features[siteID],H).addTo(map)}O?map.removeLayer(O):null;for(var e in i.features)i.features[e].properties.routeid===siteID&&(O=L.geoJson(i.features[e],{pointToLayer:function(e,t){return L.marker(t,{icon:L.icon({iconUrl:"images/alert40_red.png",iconSize:[40,40],popupAnchor:[0,-12]})})},onEachFeature:function(e,t){t.bindPopup(e.properties.alert)}}).addTo(map))}}function y(){P&&map.removeLayer(P),5>siteID&&(P=L.geoJson(t.features[siteID],{style:J}).addTo(map))}function k(){if(siteCoords.length>1)var e=siteCoords.length-1,t=[siteCoords[e-1][0],siteCoords[e][0]],o=[siteCoords[e-1][1],siteCoords[e][1]];else var t=[43.0749355058668,siteCoords[0][0]],o=[-89.39899991725407,siteCoords[0][1]];t.sort(function(e,t){return e-t}),o.sort(function(e,t){return e-t});var i=L.latLngBounds([t[0],o[0]],[t[1],o[1]]);map.fitBounds(i)}function C(){for(var e in o.features){var t=o.features[e];if(siteID===t.properties.id){$("#locationMenu").append("<li class="+t.properties.classname+'><a href="#"><img src="'+t.properties.icon.iconUrl+'"/> '+t.properties.title+"</a></li>");var i=[t.geometry.coordinates[1],t.geometry.coordinates[0]];$("#locationMenu li."+t.properties.classname).click(function(){map.setView(i,18)}),siteCoords.push(i),k()}}4===siteID&&($("#locationMenu").append('<li class="all_locations"><a href="#"><img src="images/allLocations24.png"/> View All Locations</a></li>'),$("#locationMenu li.all_locations").click(function(){var e=[];for(var t in j)e.push(j[t].getBounds());map.fitBounds(L.latLngBounds(e))}))}function x(e,t,i){i="red"==i?"icon_red_larger":"icon_larger",E=L.geoJson(o.features[t],{pointToLayer:function(e,t){return L.marker(t,{icon:L.icon(e.properties[i])})},onEachFeature:function(e,t){var o=e.properties.imageSet;imageSets[e.properties.id]=o,t.on("click",function(){M(e),B(e,o)})}}),"icon_larger"===i?j.push(E):(F&&e.removeLayer(F),F=E),e.addLayer(E)}function _(){x(map,siteID,"gray"),x(map,siteID,"red")}function M(e){currentFeature=e.properties.id,b("#textModal",0,o.features[currentFeature].properties.Scripts),x(map,currentFeature,"red")}function B(e,t){$("#show_title").html(e.properties.title+" - Site "+(e.properties.id+1)+" of 5"),$("#slideshow_texts").html().length<1&&$("#slideshow_texts").html(t[0].image_texts),$("#imagesList").html("");for(var o=document.getElementById("imagesList"),i=0;i<t.length;i++){var a=document.createElement("li");a.setAttribute("data-orbit-slide","li_"+i),a.setAttribute("id","li_"+i);var n=document.createElement("div");n.setAttribute("class","twentytwenty-container");var r=document.createElement("img"),s="desktop"==Y?"historic_large":"historic_small";r.setAttribute("onerror",'imgError(this, "'+t[i].historic_small+'")'),r.setAttribute("src",t[i][s]),n.appendChild(r);var l=document.createElement("img"),d="desktop"==Y?"current_large":"current_small";l.setAttribute("onerror",'imgError(this, "'+t[i].current_small+'")'),l.setAttribute("src",t[i][d]),n.appendChild(l),a.appendChild(n),o.appendChild(a)}if(4>siteID){var a=document.createElement("li");a.setAttribute("data-orbit-slide","li_3");var n=document.createElement("div");n.setAttribute("class","redButton"),n.setAttribute("id","ready_next"),n.innerHTML="<a href='#'><div><span>Proceed to Next Site</span></div></a>",a.appendChild(n),o.appendChild(a),n.addEventListener("click",function(){siteID++,currentFeature=siteID,C(),_(),w(),y(),v(),p(),$("#slideshowModal").foundation("reveal","close"),"desktop"==Y?setTimeout(T,1e3):setTimeout(function(){c(!1,siteID)},1e3)})}else{var a=document.createElement("li");a.setAttribute("data-orbit-slide","li_2");var n=document.createElement("div");n.setAttribute("class","lastSlide"),n.innerHTML="<span>This is a final note about the assignment. It is a very informative note. You will be quite edified after reading it, I promise.</span>",a.appendChild(n),o.appendChild(a)}$("#closeSlideshow").html("&#215;"),$("#slideshowModal").foundation("reveal","open")}function T(){u(),$("#textModal").foundation("reveal","open")}function A(){var e;if("desktop"==Y?(1.5>=V?($(".orbit-container").height("38vw"),$("#slideshowModal").data("css-top",80),$("#slideshowModal").css("top","80px")):V>1.5&&1.85>=V?($(".orbit-container").height("32vw"),$("#slideshowModal").data("css-top",70),$("#slideshowModal").css("top","70px")):V>1.85&&($(".orbit-container").height("26vw"),$("#slideshowModal").data("css-top",60),$("#slideshowModal").css("top","60px")),e="large"):($(".orbit-container").height("44vw"),e="small"),imageSets[currentFeature])for(var t=imageSets[currentFeature],o=0;o<t.length;o++)$("#li_"+o+" .twentytwenty-before").attr("src")!=t[o]["historic_"+e]&&($("#li_"+o+" .twentytwenty-before").attr("src",t[o]["historic_"+e]),$("#li_"+o+" .twentytwenty-after").attr("src",t[o]["current_"+e]))}function S(){return[$(window).height(),$(window).width()]}function I(){R=S();var e=R[0],t=R[1];Y=t>640?"desktop":"mobile",V=t/e,D(t,e),s()}function D(e,t){if($("#splashContainer").height($("body").height()),"desktop"==Y)map.attributionControl.setPosition("bottomright"),$(".reveal-modal").removeClass("full"),$(".reveal-modal").addClass("large"),$("#audioText").show(),$(".leaflet-control-zoom").show(),0===$("#readAloud").length&&($("#textModal").append('<div id="readAloud" class="redButton"><a href="#"><div><img src="images/headphones.png" alt="Read Aloud"/><span></span></div></a></div>'),p()),R[1]-$(".left").width()>120&&!iOS?$("audio").css("width",R[1]-$(".left").width()-20):$("audio").css("width",0),$("#playBubble").css({display:"none"}),mobileOS?$(".leaflet-buttons-control-img").show():$(".leaflet-buttons-control-img").hide(),$("html").scrollTop(0);else{map.attributionControl.setPosition("topright"),$(".reveal-modal").removeClass("large"),$(".reveal-modal").addClass("full"),$("#audioText").hide(),d(),$(".leaflet-control-zoom").hide(),$("#playBubble span").html("Play Audio Here");var o=t-90;$("#playBubble").offset({top:o,left:10}),$("audio").css("width","");var i=!0;$(".reveal-modal").each(function(){$(this).hasClass("open")&&(i=!1)}),i&&$(".leaflet-buttons-control-img").show()}A()}var E,F,P,O,z,j=[],H={color:"#CE3234",weight:5,opacity:.6},J={color:"#CE3234",weight:5,opacity:1},R=S(),V=R[1]/R[0],Y=R[1]>640?"desktop":"mobile",Z=!1,q=4,U=0;setHelp(a),I(),w(),y(),_(),C(),$("#splash a div").click(function(){$("#container").css("visibility","visible"),$(".ontop").css("visibility","visible"),$("nav").css("visibility","visible"),$("#splash, #splashContainer").hide(),$("body").css("overflow","hidden"),$("body").css("position","relative"),I(),$("#playBubble").offset({top:0,left:10}),$("#playBubble").animate({opacity:1,top:R[0]-90,left:10},1e3),"desktop"==Y&&T()}),$(window).on("resize",I),$("#textModal").on("close.fndtn.reveal",function(){"desktop"==Y&&r()}),$("#container").click(function(){"mobile"==Y&&n()}),$(".leaflet-clickable").click(n),$("audio").on("pause",function(){$("#readAloud span").html("&nbsp;&nbsp;Play Reading")}),$("audio").on("play",function(){$("#readAloud span").html("&nbsp;&nbsp;Pause Reading")}),0===siteID&&($("#textModal .script").html(o.features[0].properties.Scripts[0]),h("#textModal",o.features[0].properties.Scripts)),$("#slideshowModal").on("open.fndtn.reveal",function(){$(".leaflet-buttons-control-img").hide();var e=imageSets[currentFeature];$("#slideshow_texts").html(e[0].image_texts)}),$("#slideshowModal").on("opened.fndtn.reveal",function(){var e=$("#imagesList").find("li:first");e.attr("class","active");var t=$(".orbit-slide-number").find("span:last"),i=o.features[siteID].properties.imageSet.length+1;t.text(i),A(),$(".twentytwenty-container").twentytwenty()}),$("#slideshowModal").on("close.fndtn.reveal",function(){q+=4===siteID?1:0,6===q&&(P?map.removeLayer(P):null)}),$("#slideshow_images").on("after-slide-change.fndtn.orbit",function(e,t){imageSet=imageSets[currentFeature],t.slide_number<t.total_slides-1?($("#slideshow_texts").html(imageSet[t.slide_number].image_texts),4===siteID&&$(".orbit-slide-number").css("opacity",1)):t.slide_number===t.total_slides-1&&(4===siteID?($("#slideshow_texts").html(""),$(".orbit-slide-number").css("opacity",0)):4>siteID&&$("#slideshow_texts").html("After closing this slide show window, you will be guided by the highted route to the next site. If you want to explore more on this site, take the chance to navigate through images using previous or next buttons."))}),$("#infoModal").on("open.fndtn.reveal",function(){"desktop"==Y&&resizeModal($(this))}),$(".reveal-modal").on("open.fndtn.reveal",function(){$(".leaflet-buttons-control-img").hide()}),$(".reveal-modal").on("close.fndtn.reveal",function(){("mobile"==Y||1==mobileOS)&&setTimeout(function(){$(".leaflet-buttons-control-img").show()},500)})}function cacheloading(){var e=setTimeout(cacheloaded,3e4),t=0;$(window.applicationCache).on("progress",function(){clearTimeout(e),450===t&&cacheloaded(),t++,e=setTimeout(cacheloaded,3e4-66*t)}),$(window.applicationCache).on("cached",function(){cacheloaded()}),$(window.applicationCache).on("noupdate",function(){cacheloaded()}),$(window.applicationCache).on("error",function(){cacheerror()})}function cacheloaded(){$("#loading img").attr("src","images/globe.png"),$("#loading span").attr("id","loaded"),$("#loading span").text("You may now use this application offline. Without an internet connection, your map range will be more limited, but adequate for module use.")}function cacheerror(){$("#loading img").attr("src","images/globeerror.png"),$("#loading span").attr("id","error"),$("#loading span").text('There was a problem loading the offline cache. If you might lose internet connection while using this application, please hit your browser\'s "reload" button now.')}function loadmap(){map=L.map("map",{zoomControl:!1,maxZoom:18,minZoom:14,maxBounds:[[43.0371,-89.452674],[43.129626,-89.306419]],zoom:14}),L.control.zoom({position:"topleft"}).addTo(map),mapTileLayer=L.tileLayer("http://a.tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png",{attribution:'Map data &copy; <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a> <a href="http://http://leafletjs.com"> Leaflet </a> Tiles <a href="http://mapbox.com">Mapbox</a>',maxZoom:18}).addTo(map);{var e={iconUrl:"./images/findme.png",onClick:findme_button_onClick,maxWidth:30,doToggle:!1,toggleStatus:!1};new L.Control.Button(e).addTo(map)}}function findme_button_onClick(){getLocation(map)}function imgError(e,t){e.src=t}function resizeModal(e){var t=$("#container").height(),o=parseInt(e.css("top")),i=e.height();i>t&&e.height(t-2*o)}function getLocation(e){function t(t){var o=t.accuracy/2;if(firstLocate===!1&&(e.removeLayer(circle),e.removeLayer(locationMarker)),t.accuracy<90&&(circle=L.circle(t.latlng,o).addTo(e),locationMarker=L.marker(t.latlng).addTo(e).bindPopup("You are within "+Math.round(o)+" meters of this point"),firstLocate=!1),t.accuracy<40){var i=0;e.stopLocate(),i++}var a=e.getZoom();e.setView(t.latlng,a),removeFoundMarker(circle,locationMarker)}e.locate({setView:!1,watch:!0,enableHighAccuracy:!0}),e.on("locationfound",t)}function removeFoundMarker(e,t){setTimeout(function(){map.removeLayer(e),map.removeLayer(t)},1e4)}function setHelp(){}var timeouts=[],map,siteID=0,currentFeature=0,imageSets={},modernTileset=L.tileLayer("http://a.tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png"),currentTiles="modern",siteCoords=[],mapTileLayer,firstLocate=!0,iOS=!1,mobileOS=!1;window.onload=initialize();